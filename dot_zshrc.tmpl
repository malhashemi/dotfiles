# ============================================================================
# ZSH Configuration
# ============================================================================

# Completion System Setup
setopt prompt_subst
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
autoload bashcompinit && bashcompinit
autoload -Uz compinit
compinit

# ============================================================================
# Zinit Plugin Manager
# ============================================================================

{{- if eq .chezmoi.os "darwin" }}
# macOS: Source Zinit from Homebrew (supports both Apple Silicon and Intel)
if [[ -f /opt/homebrew/opt/zinit/zinit.zsh ]]; then
    # Apple Silicon
    source /opt/homebrew/opt/zinit/zinit.zsh
    source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
    source /opt/homebrew/share/zsh-fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh
    source /opt/homebrew/share/zsh-autopair/autopair.zsh
elif [[ -f /usr/local/opt/zinit/zinit.zsh ]]; then
    # Intel Mac
    source /usr/local/opt/zinit/zinit.zsh
    source /usr/local/share/zsh-autosuggestions/zsh-autosuggestions.zsh
    source /usr/local/share/zsh-fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh
    source /usr/local/share/zsh-autopair/autopair.zsh
fi
{{- else }}
# Linux: Self-managed Zinit installation
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
[ ! -d $ZINIT_HOME ] && mkdir -p "$(dirname $ZINIT_HOME)"
[ ! -d $ZINIT_HOME/.git ] && git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
source "${ZINIT_HOME}/zinit.zsh"

# Load plugins via Zinit
zinit light zsh-users/zsh-autosuggestions
zinit light zdharma-continuum/fast-syntax-highlighting
zinit light hlissner/zsh-autopair
{{- end }}

# Removed zsh-autocomplete - it's incompatible with menu-complete tab cycling

# Configure tab for cycling through completions (standard ZSH completion)
bindkey '\t' menu-complete
bindkey "$terminfo[kcbt]" reverse-menu-complete

# Enable menu selection with highlighting
zstyle ':completion:*' menu select
zstyle ':completion:*' list-colors ''

# ============================================================================
# Key Bindings
# ============================================================================

# Autosuggestions key bindings
bindkey '^w' autosuggest-execute
bindkey '^e' autosuggest-accept
bindkey '^u' autosuggest-toggle
bindkey '^k' up-line-or-search
bindkey '^j' down-line-or-search

# ============================================================================
# Environment Variables
# ============================================================================

export LANG=en_US.UTF-8
export EDITOR="nvim"
export GOPATH="$HOME/go"
export XDG_CONFIG_HOME="$HOME/.config"

# Clipboard CLI wrapper - reads theme fresh each time for runtime theme switching
cb() {
    [[ -f "$XDG_CONFIG_HOME/clipboard/theme" ]] && export CLIPBOARD_THEME="$(cat "$XDG_CONFIG_HOME/clipboard/theme")"
    command cb "$@"
}

# FZF Configuration (kept for compatibility with tools that still use it)
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow'
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# Television is installed but kept as optional tool
# Not used in functions due to terminal compatibility issues

# ============================================================================
# Aliases
# ============================================================================

# Editor
alias e="nvim"
{{- if not .is_headless }}
alias v="neovide"
{{- end }}

# Modern CLI replacements
alias cat="bat"
alias l="eza -l --icons --git -a"
alias lt="eza --tree --level=2 --long --icons --git -a"
alias ltree="eza --tree --level=2 --icons --git -a"
alias la="tree"
alias cl="clear"

# Directory navigation
alias ~="cd ~"
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."
alias .....="cd ../../../.."
alias ......="cd ../../../../.."

# Git aliases
alias gc="git commit -m"
alias gca="git commit -a -m"
alias gp="git push origin HEAD"
alias gpu="git pull origin"
alias gst="git status"
alias glog="git log --graph --topo-order --pretty='%w(100,0,6)%C(yellow)%h%C(bold)%C(black)%d %C(cyan)%ar %C(green)%an%n%C(bold)%C(white)%s %N' --abbrev-commit"
alias gdiff="git diff"
alias gco="git checkout"
alias gb="git branch"
alias gba="git branch -a"
alias gadd="git add"
alias ga="git add -p"
alias gcoall="git checkout -- ."
alias gr="git remote"
alias gre="git reset"

# Docker aliases (when Docker is installed)
alias dco="docker compose"
alias dps="docker ps"
alias dpa="docker ps -a"
alias dl="docker ps -l -q"
alias dx="docker exec -it"

# Tools
alias http="xh"
alias lg="lazygit"

# Arabic text reading (fribidi for proper RTL display)
alias acat="fribidi"                    # Read Arabic from stdin/pipe
alias ar="fribidi"                      # Short alias for Arabic reading

# Television aliases for quick access
alias tvf="tv files"  # Quick file search
alias tvd="tv dirs"   # Quick directory search
alias tvg="tv git-repos"  # Find git repositories
alias tvh="tv zsh-history"  # Search zsh history

# Remote Machines
{{- if .tailscale_enabled }}

# Connect to devbox with optional session name (defaults to "dev")
unalias devbox 2>/dev/null
devbox() {
    local session=${1:-dev}
    mosh {{ .chezmoi.username }}@{{ .tailscale_hosts.dev_hub }} -- zellij attach --create "$session"
}

# Raw mosh access without zellij
alias devhub="mosh {{ .chezmoi.username }}@{{ .tailscale_hosts.dev_hub }}"

# Delete zellij session by name (defaults to "dev")
unalias zeldel 2>/dev/null
zeldel() {
    local session=${1:-dev}
    ssh {{ .chezmoi.username }}@{{ .tailscale_hosts.dev_hub }} "zellij delete-session $session"
}
{{- end }}

# ============================================================================
# Functions
# ============================================================================

# Change directory and list contents
cx() { cd "$@" && l; }

# Fuzzy find directory and cd into it
fcd() {
    local dir=$(find . -type d -not -path '*/.*' | fzf --preview 'eza -la --color=always {}')
    [ -n "$dir" ] && cd "$dir" && l
}

# Fuzzy find file and copy path to clipboard
f() {
    local file=$(find . -type f -not -path '*/.*' | fzf --preview 'bat --color=always {}')
{{- if eq .chezmoi.os "darwin" }}
    [ -n "$file" ] && echo "$file" | pbcopy
{{- else }}
    [ -n "$file" ] && echo "$file" | wl-copy || xclip -selection clipboard
{{- end }}
}

{{- if not .is_headless }}
# Fuzzy find file and open in Neovide (GUI only)
fv() {
    local file=$(find . -type f -not -path '*/.*' | fzf --preview 'bat --color=always {}')
    [ -n "$file" ] && neovide "$file"
}
{{- end }}

{{- if eq .chezmoi.os "darwin" }}
# Fuzzy find and focus aerospace window (macOS only)
ff() {
    aerospace list-windows --all | fzf | awk '{print $1}' | xargs -I {} aerospace focus --window-id {}
}
{{- end }}

# Yazi with directory change on exit
function y() {
    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
    yazi "$@" --cwd-file="$tmp"
    if cwd="$(command cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
        cd -- "$cwd"
    fi
    rm -f -- "$tmp"
}

# Read Arabic file with proper RTL display
# Usage: afile filename.txt
function afile() {
    if [ -z "$1" ]; then
        echo "Usage: afile <filename>"
        return 1
    fi
    command cat "$1" | fribidi | less -R
}

# Tail Arabic logs with proper RTL display  
# Usage: atail filename.log
function atail() {
    if [ -z "$1" ]; then
        echo "Usage: atail <filename>"
        return 1
    fi
    tail -f "$1" | fribidi
}

# ============================================================================
# Tool Initializations
# ============================================================================

# Starship prompt
eval "$(starship init zsh)"
export STARSHIP_CONFIG=~/.config/starship/starship.toml

# Atuin shell history
[ -f "$HOME/.atuin/bin/env" ] && . "$HOME/.atuin/bin/env"
command -v atuin &>/dev/null && eval "$(atuin init zsh)"

# Zoxide smart cd
eval "$(zoxide init zsh)"

# ============================================================================
# Completions
# ============================================================================

# Load completions if available
if command -v kubectl &> /dev/null; then
    source <(kubectl completion zsh)
fi

if command -v aws &> /dev/null && command -v aws_completer &> /dev/null; then
    complete -C "$(command -v aws_completer)" aws
fi

# Display system info on terminal startup
command -v fastfetch &>/dev/null && fastfetch --config examples/13

{{- if eq .chezmoi.os "darwin" }}
# macOS PATH additions (Homebrew, .local/bin, .cargo/bin already set by zprofile/zshenv)
export PATH="$HOME/.bun/bin:$HOME/.atuin/bin:$HOME/go/bin:/Applications/Ghostty.app/Contents/MacOS:$PATH"

# Python user packages (version-agnostic)
for pydir in "$HOME/Library/Python"/*/bin(N); do
    [[ -d "$pydir" ]] && export PATH="$pydir:$PATH"
done

# Zed
alias zed="/Applications/Zed.app/Contents/MacOS/cli"
{{- else }}
# Linux PATH additions (minimal - .local/bin already in zshenv handles pip packages)
export PATH="$HOME/.bun/bin:$HOME/.atuin/bin:$HOME/go/bin:$PATH"
{{- end }}
alias ascii="~/scripts/figlet.sh"
alias theme="~/.config/theme-system/scripts/theme-manager.py"
alias wallpaper="~/.config/theme-system/scripts/wallpaper-manager.py"
alias secrets="~/scripts/secrets.sh && source ~/.secrets"

# pnpm
export PNPM_HOME="/home/malhashemi/.local/share/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end

setopt INTERACTIVE_COMMENTS
