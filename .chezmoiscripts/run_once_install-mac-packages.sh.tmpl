#!/usr/bin/env bash
# chezmoi:template:left-delimiter="{{" right-delimiter="}}"
{{ if ne .chezmoi.os "darwin" -}}
# Skip on non-macOS systems
exit 0
{{ end -}}

set -e

echo "=========================================="
echo "  macOS Package Installation"
echo "=========================================="

# Check for Homebrew
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH for this session
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

echo ""
echo "Adding taps..."
echo "-------------------------------------------"
brew tap charmbracelet/tap
brew tap felixkratz/formulae
brew tap gromgit/brewtils
brew tap lhvy/tap
brew tap nikitabobko/tap
brew tap oven-sh/bun
brew tap sst/tap
brew tap valkyrie00/bbrew

echo ""
echo "Installing core CLI tools..."
echo "-------------------------------------------"
brew install \
    chezmoi \
    git gh lazygit gitui git-delta \
    neovim \
    bat eza fd ripgrep fzf \
    zoxide yazi television \
    just jq tree xh

echo ""
echo "Installing shell enhancements..."
echo "-------------------------------------------"
brew install \
    starship \
    atuin \
    zinit \
    nushell \
    zsh-autosuggestions \
    zsh-fast-syntax-highlighting \
    zsh-autocomplete \
    zsh-autopair

echo ""
echo "Installing TUI apps..."
echo "-------------------------------------------"
brew install \
    btop bottom \
    ncspot spotifyd \
    cava \
    posting \
    glow

echo ""
echo "Installing languages & runtimes..."
echo "-------------------------------------------"
brew install \
    rust go lua \
    node oven-sh/bun/bun deno pnpm \
    uv pipx

echo ""
echo "Installing language servers..."
echo "-------------------------------------------"
brew install \
    lua-language-server \
    typescript-language-server \
    yaml-language-server \
    vscode-langservers-extracted \
    cmake-language-server \
    dockerfile-language-server \
    tailwindcss-language-server \
    sql-language-server \
    kotlin-language-server \
    jdtls \
    texlab marksman zls taplo

echo ""
echo "Installing macOS-specific tools..."
echo "-------------------------------------------"
brew install \
    felixkratz/formulae/borders \
    felixkratz/formulae/sketchybar \
    wallpaper

# matugen is not in Homebrew - install via cargo
if ! command -v matugen &> /dev/null; then
    echo "Installing matugen via cargo..."
    cargo install matugen
fi

echo ""
echo "Installing utilities..."
echo "-------------------------------------------"
brew install \
    mosh \
    ffmpeg imagemagick \
    p7zip sevenzip unzip \
    rclone \
    speedtest-cli gping \
    fastfetch \
    figlet toilet cmatrix lhvy/tap/pipes-rs tty-clock

echo ""
echo "Installing other dev tools..."
echo "-------------------------------------------"
brew install \
    sst/tap/opencode \
    charmbracelet/tap/crush \
    gromgit/brewtils/taproom \
    valkyrie00/bbrew/bbrew \
    biome repomix dart-sdk llvm cmake-language-server

echo ""
echo "Installing GUI apps (casks)..."
echo "-------------------------------------------"
# Install casks individually to handle errors gracefully
# (some casks have buggy definitions that fail even when installed)
for cask in wezterm neovide-app aerospace flameshot docker-desktop visual-studio-code; do
    brew install --cask "$cask" 2>/dev/null || echo "  ⚠️  $cask: skipped (already installed or error)"
done

echo ""
echo "Installing fonts..."
echo "-------------------------------------------"
for font in font-jetbrains-mono font-jetbrains-mono-nerd-font font-hack-nerd-font \
            font-monocraft font-fontawesome font-symbols-only-nerd-font \
            font-barlow font-inter; do
    brew install --cask "$font" 2>/dev/null || echo "  ⚠️  $font: skipped (already installed or error)"
done

echo ""
echo "Installing Go tools..."
echo "-------------------------------------------"
go install github.com/nametake/golangci-lint-langserver@latest
go install golang.org/x/tools/gopls@latest
go install honnef.co/go/tools/cmd/staticcheck@latest

echo ""
echo "=========================================="
echo "  Installation Complete!"
echo "=========================================="
echo ""
echo "Next steps:"
echo "  1. Restart your terminal"
echo "  2. Run: chezmoi apply"
echo "  3. Start services: brew services start borders && brew services start sketchybar"
echo "  4. Configure aerospace in System Settings > Login Items"
echo ""
