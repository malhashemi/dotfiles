local wezterm = require("wezterm")
local config = wezterm.config_builder()

-- ============================================================================
-- THEME INTEGRATION
-- ============================================================================
-- Single source of truth: colors-wezterm.lua (colors)
-- Single source of truth: opacity-wezterm.lua (opacity)
-- Both generated by theme system for on-the-fly updates

config.colors = require("colors-wezterm")

-- ============================================================================
-- DYNAMIC COLOR PUSH (fixes WezTerm per-pane palette caching bug)
-- ============================================================================
-- When config reloads, WezTerm updates window-level colors but NOT per-pane
-- terminal state. This causes OSC 10/11 queries to return stale values.
-- Fix: Push colors to all panes via OSC sequences on config reload.

local function push_colors_to_pane(pane)
	-- Reload the colors module to get fresh values
	package.loaded["colors-wezterm"] = nil
	local ok, colors = pcall(require, "colors-wezterm")
	if not ok or not colors then return end

	-- Push ANSI colors 0-7 (OSC 4)
	if colors.ansi then
		for i, color in ipairs(colors.ansi) do
			pane:inject_output(string.format("\x1b]4;%d;%s\x07", i - 1, color))
		end
	end

	-- Push bright colors 8-15 (OSC 4)
	if colors.brights then
		for i, color in ipairs(colors.brights) do
			pane:inject_output(string.format("\x1b]4;%d;%s\x07", i + 7, color))
		end
	end

	-- Push foreground (OSC 10)
	if colors.foreground then
		pane:inject_output(string.format("\x1b]10;%s\x07", colors.foreground))
	end

	-- Push background (OSC 11)
	if colors.background then
		pane:inject_output(string.format("\x1b]11;%s\x07", colors.background))
	end

	-- Push cursor color (OSC 12)
	if colors.cursor_bg then
		pane:inject_output(string.format("\x1b]12;%s\x07", colors.cursor_bg))
	end
end

-- Push colors to ALL panes when config reloads
wezterm.on("window-config-reloaded", function(window, pane)
	for _, tab in ipairs(window:mux_window():tabs()) do
		for _, p in ipairs(tab:panes()) do
			push_colors_to_pane(p)
		end
	end
end)

-- Load opacity settings
local opacity = require("opacity-wezterm")
if opacity.enabled then
	config.window_background_opacity = opacity.opacity
	{{- if eq .chezmoi.os "darwin" }}
	if opacity.blur then
		config.macos_window_background_blur = opacity.blur
	end
	{{- end }}
end

-- ============================================================================
-- BASIC CONFIGURATION
-- ============================================================================

config.adjust_window_size_when_changing_font_size = false
config.automatically_reload_config = true
config.enable_tab_bar = false
config.font_size = {{ .preferences.terminal.font_size }}
config.font = wezterm.font_with_fallback({
	"{{ .preferences.terminal.font_family }}",
	"Tajawal",  -- Arabic fallback (user's favorite)
})
config.window_decorations = "RESIZE"

-- ============================================================================
-- KEY BINDINGS
-- ============================================================================

config.keys = {
	{
		key = "q",
		mods = "CTRL",
		action = wezterm.action.ToggleFullScreen,
	},
	{
		key = "'",
		mods = "CTRL",
		action = wezterm.action.ClearScrollback("ScrollbackAndViewport"),
	},
	{
		key = "w",
		mods = "CMD",
		action = wezterm.action.CloseCurrentPane({ confirm = false }),
	},
	{
		key = "d",
		mods = "CMD",
		action = wezterm.action.SplitHorizontal({ domain = "CurrentPaneDomain" }),
	},
	{
		key = "d",
		mods = "CMD|SHIFT",
		action = wezterm.action.SplitVertical({ domain = "CurrentPaneDomain" }),
	},
	{
		key = "k",
		mods = "CMD",
		action = wezterm.action.Multiple({
			wezterm.action.SendString("clear"),
			wezterm.action.SendKey({ key = "Enter" }),
		}),
	},
	{
		key = "t",
		mods = "CMD|SHIFT",
		action = wezterm.action_callback(function(win, pane)
			pane:move_to_new_window()
		end),
	},
	{
		key = "t",
		mods = "CMD|SHIFT|CTRL",
		action = wezterm.action_callback(function(win, pane)
			pane:move_to_new_tab()
		end),
	},
}

-- ============================================================================
-- MOUSE BINDINGS
-- ============================================================================

config.mouse_bindings = {
	{
		event = { Up = { streak = 1, button = "Left" } },
		mods = "CTRL",
		action = wezterm.action.OpenLinkAtMouseCursor,
	},
}

return config
