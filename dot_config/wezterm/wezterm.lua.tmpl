local wezterm = require("wezterm")
local config = wezterm.config_builder()

-- ============================================================================
-- THEME INTEGRATION
-- ============================================================================
-- Single source of truth: colors-wezterm.lua (colors)
-- Single source of truth: opacity-wezterm.lua (opacity)
-- Both generated by theme system for on-the-fly updates

config.colors = require("colors-wezterm")

-- Load opacity settings
local opacity = require("opacity-wezterm")
if opacity.enabled then
	config.window_background_opacity = opacity.opacity
	{{- if eq .chezmoi.os "darwin" }}
	if opacity.blur then
		config.macos_window_background_blur = opacity.blur
	end
	{{- end }}
end

-- ============================================================================
-- BASIC CONFIGURATION
-- ============================================================================

config.adjust_window_size_when_changing_font_size = false
config.automatically_reload_config = true
config.enable_tab_bar = false
config.font_size = {{ .preferences.terminal.font_size }}
config.font = wezterm.font("{{ .preferences.terminal.font_family }}")
config.window_decorations = "RESIZE"

-- ============================================================================
-- KEY BINDINGS
-- ============================================================================

config.keys = {
	{
		key = "q",
		mods = "CTRL",
		action = wezterm.action.ToggleFullScreen,
	},
	{
		key = "'",
		mods = "CTRL",
		action = wezterm.action.ClearScrollback("ScrollbackAndViewport"),
	},
	{
		key = "w",
		mods = "CMD",
		action = wezterm.action.CloseCurrentPane({ confirm = false }),
	},
	{
		key = "d",
		mods = "CMD",
		action = wezterm.action.SplitHorizontal({ domain = "CurrentPaneDomain" }),
	},
	{
		key = "d",
		mods = "CMD|SHIFT",
		action = wezterm.action.SplitVertical({ domain = "CurrentPaneDomain" }),
	},
	{
		key = "k",
		mods = "CMD",
		action = wezterm.action.Multiple({
			wezterm.action.SendString("clear"),
			wezterm.action.SendKey({ key = "Enter" }),
		}),
	},
	{
		key = "t",
		mods = "CMD|SHIFT",
		action = wezterm.action_callback(function(win, pane)
			pane:move_to_new_window()
		end),
	},
	{
		key = "t",
		mods = "CMD|SHIFT|CTRL",
		action = wezterm.action_callback(function(win, pane)
			pane:move_to_new_tab()
		end),
	},
}

-- ============================================================================
-- MOUSE BINDINGS
-- ============================================================================

config.mouse_bindings = {
	{
		event = { Up = { streak = 1, button = "Left" } },
		mods = "CTRL",
		action = wezterm.action.OpenLinkAtMouseCursor,
	},
}

return config
